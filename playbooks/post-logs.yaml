- hosts: all
  tasks:


    - name: Set log path for a change
      when: zuul.change is defined
      set_fact:
        log_path: "{{ zuul.change[-2:] }}/{{ zuul.change }}/{{ zuul.patchset }}/{{ zuul.pipeline }}/{{ zuul.job }}/{{ zuul.build[:7] }}"

    - name: Set log path for a ref update
      when: zuul.newrev is defined
      set_fact:
        log_path: "{{ zuul.newrev[-2:] }}/{{ zuul.newrev }}/{{ zuul.pipeline }}/{{ zuul.job }}/{{ zuul.build[:7] }}"

    - name: Set log path for a periodic job
      when: zuul.change is not defined and zuul.newrev is not defined
      set_fact:
        log_path: "{{ zuul.pipeline }}/{{ zuul.job }}/{{ zuul.build[:7] }}"

    - name: Create tmp one more
      tempfile:
        state: file
      register: tmpe

    - name: Create ssh file
      copy:
        content: |
          sshpass -p ubuntu ssh -o StrictHostKeyChecking=no ubuntu@10.13.120.209 "mkdir -p /var/www/logs/{{ log_path }}"
          sshpass -p ubuntu scp -o StrictHostKeyChecking=no -R {{ zuul.executor.log_root }}/ ubuntu@10.13.120.209:/var/www/logs/{{ log_path }}/
        dest: "{{ tmpe.path }}"
        mode: 0777

    - name: run ssh command
      shell: bash {{ tmpe.path }}
#    - name: Add log server
#      shell: ssh-add {{ ssh_private_key_tmp.path }}
#      script: /home/zuul/test.sh
#      raw: rsync -a --exclude=job-output.txt --rsync-path="mkdir -p /var/www/logs/{{ log_path }}/ && rsync" "{{ zuul.executor.log_root }}/" ubuntu@10.13.120.209:/var/www/logs/{{ log_path }}/

#    - name: Upload logs to log server
#      local_action: shell  "sh /home/zuul/test.sh"
#      script: /home/zuul/test.sh
#      raw: rsync -a --exclude=job-output.txt --rsync-path="mkdir -p /var/www/logs/{{ log_path }}/ && rsync" "{{ zuul.executor.log_root }}/" ubuntu@10.13.120.209:/var/www/logs/{{ log_path }}/
- hosts: 10.13.120.209
  tasks:

    - name: Gzip console log
      delegate_to: localhost
      archive:
        path: "{{ zuul.executor.log_root }}/job-output.txt"

    - name: Upload console log
      synchronize:
        src: "{{ zuul.executor.log_root }}/job-output.txt.gz"
        dest: "/var/www/logs/{{ log_path }}/job-output.txt.gz"
        verify_host: true

#    - name: Upload console log
#      delegate_to: localhost
#      raw:  rsync -a "{{ zuul.executor.log_root }}/job-output.txt.gz" ubuntu@10.13.120.209:/var/www/logs/{{ log_path }}/job-output.txt.gz

    - name: Add fileserver to inventory
      delegate_to: localhost
      zuul_return:
        data:
          zuul:
            log_url: "http://15.184.0.52/{{ log_path }}/"
